FROM artifacts.developer.gov.bc.ca/dbe7-images/rhel8-python39:1-196.1725368453

COPY prohibition_web_svc/requirements.txt /tmp/

RUN pip3 install -U pip
RUN pip3 install -r /tmp/requirements.txt

# Install system dependencies for Playwright
RUN yum update -y && \
    yum install -y \
    glib2-devel \
    nss \
    nspr \
    atk \
    at-spi2-atk \
    cups-libs \
    drm \
    gtk3 \
    libXcomposite \
    libXdamage \
    libXrandr \
    libgbm \
    libxss \
    alsa-lib \
    liberation-fonts \
    dejavu-fonts-common \
    && yum clean all

# Install Playwright browsers
RUN source /opt/app-root/etc/scl_enable && \
    playwright install chromium

# Install Playwright system dependencies (skip problematic fonts)
RUN source /opt/app-root/etc/scl_enable && \
    playwright install-deps chromium || true

# RUN useradd --create-home appuser
# WORKDIR /home/appuser
# USER appuser

COPY common /home/appuser/python/common
COPY prohibition_web_svc /home/appuser/python/prohibition_web_svc

ENV PYTHONPATH /home/appuser/

# RUN ["python", "-m", "pytest"]
CMD [ "gunicorn", "--bind", "0.0.0.0:5000", "--pythonpath", "/home/appuser/python/prohibition_web_svc", "app:create_app()" ]